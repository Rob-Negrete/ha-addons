# Dedicated test container - optimized for speed
FROM python:3.11-slim

# Install system dependencies (minimal)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libgl1 \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 3-layer approach to reduce disk space pressure per layer
# Layer 1: PyTorch + core libs (must install torch FIRST)
RUN pip install --no-cache-dir \
    'numpy<2.0.0' \
    torch \
    torchvision

# Layer 2: ML processing libraries (reuse torch from Layer 1)
RUN pip install --no-cache-dir \
    onnxruntime \
    pillow \
    opencv-python-headless \
    insightface==0.7.3

# Layer 3: Enhanced image processing + Flask + Testing
# Note: realesrgan pulls in basicsr, facexlib, gfpgan
RUN pip install --no-cache-dir \
    realesrgan==0.3.0 \
    flask==3.1.2 \
    flask-cors==6.0.1 \
    flask-restx==1.3.0 \
    qdrant-client==1.7.0 \
    pytest==7.4.0 \
    pytest-cov==4.1.0

# Set working directory
WORKDIR /app

# Copy test files (do this last for faster rebuilds)
COPY tests/ tests/
COPY scripts/ scripts/
COPY pytest*.ini ./
COPY run_tests.py ./

# Default command
CMD ["python", "run_tests.py", "all"]
